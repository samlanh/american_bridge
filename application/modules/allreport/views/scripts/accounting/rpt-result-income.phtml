<?php
	$tr = Application_Form_FrmLanguages::getCurrentlanguage();
	$frm =  $this->form_search;
	//print_r($this->rs);
?>	
<title><?php echo $tr->translate('របាយការណ៍លទ្ធផលចំណូល');?></title>
	<form  id='foundation_class' action="<?php echo $this->url(array('module'=>'allreport','controller'=>'accounting','action'=>'rpt-result-income')); ?>" dojoType="dijit.form.Form" method="post" enctype="application/x-www-form-urlencoded">
		<table width="100%">
		    <tr>
		    	<td> <?php echo $frm->getElement("start_date");?></td>
	   	  	    <td> <?php echo $frm->getElement("end_date");?></td>
		    	<td><?php echo $frm->getElement('branch');?></td>
		    	<td><?php echo $frm->getElement('user');?></td>
		    	<td>
				 	<select name="shift"  id="shift" dojoType="dijit.form.FilteringSelect" class="fullside" >
				 		<option value="0" <?php if($this->search['shift']==0){echo 'selected="selected"';}?>>Shift</option>
				 		<option value="1" <?php if($this->search['shift']==1){echo 'selected="selected"';}?>>10:00am</option>
				 		<option value="2" <?php if($this->search['shift']==2){echo 'selected="selected"';}?>>04:00pm</option>
				 		<option value="3" <?php if($this->search['shift']==3){echo 'selected="selected"';}?>>06:30pm</option>
				 	</select>
				</td>
		    	<td><button iconclass="dijitIconSearch" dojoType="dijit.form.Button" showLabel="true" type="submit"><?php echo $tr->translate("SEARCH");?></button> </td>
		    </tr>
		</table>
	</form>	
	
	<style>
		.hover:hover{background: #ddd;}
	</style>
	
	<div style="border: 1px dotted #000;background: #fff; margin: 0 auto;min-height: 27cm; padding: 0.5cm;">
		<div id="divPrint">
		<style>
			table{ page-break-inside:auto }
		    tr{ page-break-inside:avoid; page-break-after:auto }
			#header {
				display: table-header-group;
				page-break-inside:avoid; page-break-after:auto;
			}
			.bor{
				border-right: 1px solid #000;	
				border-bottom: 1px solid #000;
				font-size:13px;
			}
			.bor_r{
				border-right: 1px solid #000;	
				font-size:13px;
			}
			.padd{
				padding: 3px;	
			}
			#row{ font-size:12px; height: 30px;border: 1px solid #000;font-family:'Khmer OS Battambang';  }
		</style>
		
		<table style="background:#fff;width:90%; margin: 0 auto;width: 100%;font-family:'Khmer OS Battambang';">
			<tr>
				<td width="15%" align="center">
					<img style="width:60%;" src="<?php echo $this->baseUrl().'/images/logo.png'?>">
				</td>
				<td align="center" width="70%" style="font-weight:bold;font-family: Arial Black;color:#000; font-size: 16px;font-family:'Khmer MEF2';​">
					<strong style="font-weight:bold;font-family: Arial Black;color:#000; font-size: 16px;font-family:'Khmer MEF2';​"><?php echo $tr->translate("របាយការណ៍លទ្ធផលចំណូល"); ?></strong><br />
					<strong  style="font-weight:bold;color:#000; font-size: 13px;font-family:'Khmer OS Muol';​">Income Statement (AR) <br />From <?php echo date('d-m-Y',strtotime($this->search['start_date']));?> To <?php echo date('d-m-Y',strtotime($this->search['end_date']));?></strong><br />
				</td>
				<td width="15%" > </td>
			</tr>
			<tr>
				<td colspan="3" id="exportExcel">
					<table cellpadding="8"​ style="margin:0 auto;width:100%; border-collapse: collapse;white-space: nowrap;font-family:'Khmer OS Battambang';"  border="1" >
						<thead>
							<tr style="font-size:12px;height: 20px;line-height: 30px;font-weight: bold;background: rgba(67, 200, 207, 0.82);" align="center" ><!-- rgba(101, 177, 70, 0.82) -->
								<td class="bor"><?php echo $tr->translate("លេខគណនី"); ?>/Account Code</td>
								<td class="bor" ><?php echo $tr->translate("ឈ្មោះគណនីជាខ្មែរ"); ?>/Account in Khmer</td>
								<td class="bor"  ><?php echo $tr->translate("ឈ្មោះគណនីជាអង់គ្គេស"); ?>/Account in English</td>
								<td class="bor"><?php echo $tr->translate("សរុប"); ?>/Amount</td>
								<td class="bor"><?php echo $tr->translate("Amount Riel"); ?></td>
								<td class="bor"><?php echo $tr->translate("Receipt Number"); ?></td>
						    </tr>
						</thead>
	 					<tr id="row" align="center" >
							<td> </td>
							<td  class="padd"  style="background:#4682B4;">ចំណូល</td>
							<td  class="padd"  style="background:#81BEF7;">Revenue</td>
							<td colspan="3"> </td>
	 					</tr>
	 					
	 					<?php 	$i=0;
	 							$category_id=0;
	 							$account_no=""; 
	 							$title="";
	 							$total_by_category=0; 
	 							$total_kft=0;
	 							$grand_total = 0;
	 							$grand_total_in_dollar = 0;
	 							$grand_total_in_riel = 0;
	 							$total_tuition_fee=0;
	 					?>
	 					
	 		<?php /////////////////////////////// kft /////////////////////////////////////////////////////////////////////// ?>					
	 					<?php 		
	 						if(!empty($this->kft)){ foreach($this->kft as $kft){
		 						$total_kft = $total_kft + $kft['grand_total_payment'];
	 							$account_no = $kft['account_no'];
	 							$title = $kft['category'];
	 						}} 
	 					?>
	 					
	 					<?php 
		 					$total_khmerft_in_riel=0;
		 					$total_khmerft_in_dolar=0;
		 					if(!empty($this->kft_amount_money)){
		 						foreach ($this->kft_amount_money as $kft_money){
		 							$total_khmerft_in_riel = $total_khmerft_in_riel + $kft_money['amount_riel'];
		 							$total_khmerft_in_dolar = $total_khmerft_in_dolar + $kft_money['amount_usd'];
		 						}
		 					}
	 					?>
	 					
	 		<?php ////////////////////////////////// eft //////////////////////////////////////////////////////////////////// ?>			
	 					<?php 	$total_eft=0;
	 						if(!empty($this->eft)){ foreach($this->eft as $eft){
		 						$total_eft = $total_eft + $eft['grand_total_payment'];
	 							$account_no = $eft['account_no'];
	 							$title = $eft['category'];
	 							
	 						}} 
	 					?>
	 					<?php 
		 					$total_englishft_in_riel=0;
		 					$total_englishft_in_dolar=0;
		 					if(!empty($this->eft_amount_money)){
		 						foreach ($this->eft_amount_money as $eft_money){
		 							$total_englishft_in_riel = $total_englishft_in_riel + $eft_money['amount_riel'];
		 							$total_englishft_in_dolar = $total_englishft_in_dolar + $eft_money['amount_usd'];
		 						}
		 					}
	 					?>
	 					
	 		<?php ////////////////////////////////// ept //////////////////////////////////////////////////////////////////// ?>			
	 					<?php 	$total_ept=0;
	 						if(!empty($this->ept)){ foreach($this->ept as $ept){
		 						$total_ept = $total_ept + $ept['grand_total_payment'];
	 							$account_no = $ept['account_no'];
	 							$title = $ept['category'];
	 							
	 						}} 
	 					?>
	 					
	 					<?php 
		 					$total_englishpt_in_riel=0;
		 					$total_englishpt_in_dolar=0;
		 					if(!empty($this->ept_amount_money)){
		 						foreach ($this->ept_amount_money as $ept_money){
		 							$total_englishpt_in_riel = $total_englishpt_in_riel + $ept_money['amount_riel'];
		 							$total_englishpt_in_dolar = $total_englishpt_in_dolar + $ept_money['amount_usd'];
		 						}
		 					}
	 					?>
	 					
	 		<?php ////////////////////////////////// total tuition fee /////////////////////////////////////////////////////////////////////////// ?>			
	 					
	 					<?php 
	 						$total_tuition_fee = $total_kft + $total_eft + $total_ept;
	 						$total_tuition_fee_in_dollar = $total_khmerft_in_dolar + $total_englishft_in_dolar + $total_englishpt_in_dolar;
	 						$total_tuition_fee_in_riel = $total_khmerft_in_riel + $total_englishft_in_riel + $total_englishpt_in_riel;
	 						
	 						if($total_tuition_fee>0){?>
		 					<tr>
								<td align="center">&nbsp;&nbsp;<?php echo $account_no;?></td>
								<td>&nbsp;&nbsp;<?php echo $title;?></td>
								<td>&nbsp;&nbsp;<?php echo $title;?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_tuition_fee)){echo "$ ".number_format($total_tuition_fee,2);}?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_tuition_fee_in_dollar)){echo "$ ".number_format($total_tuition_fee_in_dollar,2);}?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_tuition_fee_in_riel)){echo number_format($total_tuition_fee_in_riel,2)." ៛";}?></td>
							</tr>
	 					<?php }?>		
	 						
	 		<?php ////////////////////////////////// transport //////////////////////////////////////////////////////////////////// ?>			
	 					<?php 	$total_car=0;
	 						if(!empty($this->car)){ foreach($this->car as $car){
		 						$total_car = $total_car + $car['grand_total_payment'];
	 							$account_no = $car['account_no'];
	 							$title = $car['category'];
	 						}} 
	 					?>
	 					
	 					<?php 
		 					$total_car_in_riel=0;
		 					$total_car_in_dolar=0;
		 					if(!empty($this->transport_amount_money)){
		 						foreach ($this->transport_amount_money as $transport_money){
		 							$total_car_in_riel = $total_car_in_riel + $transport_money['amount_riel'];
		 							$total_car_in_dolar = $total_car_in_dolar + $transport_money['amount_usd'];
		 						}
		 					}
	 					?>
	 					
	 					<?php 
	 						if($total_car>0){?>
		 					<tr>
								<td align="center">&nbsp;&nbsp;<?php echo $account_no;?></td>
								<td>&nbsp;&nbsp;<?php echo $title;?></td>
								<td>&nbsp;&nbsp;<?php echo $title;?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_car)){echo "$ ".number_format($total_car,2);}?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_car_in_dolar)){echo "$ ".number_format($total_car_in_dolar,2);}?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_car_in_riel)){echo number_format($total_car_in_riel,2)." ៛";}?></td>
							</tr>
	 					<?php }?>
	 					
	 		<?php ////////////////////////////////// food //////////////////////////////////////////////////////////////////// ?>			
	 					<?php 	$total_food=0;
	 						if(!empty($this->food)){ foreach($this->food as $food){
		 						$total_food = $total_food + $food['grand_total_payment'];
	 							$account_no = $food['account_no'];
	 							$title = $food['category'];
	 						}} 
	 					?>
	 					
	 					<?php 
		 					$total_food_in_riel=0;
		 					$total_food_in_dolar=0;
		 					if(!empty($this->food_amount_money)){
		 						foreach ($this->food_amount_money as $food_money){
		 							$total_food_in_riel = $total_food_in_riel + $food_money['amount_riel'];
		 							$total_food_in_dolar = $total_food_in_dolar + $food_money['amount_usd'];
		 						}
		 					}
	 					?>
	 					
	 					<?php 
	 						if($total_food>0){?>
		 					<tr>
								<td align="center">&nbsp;&nbsp;<?php echo $account_no;?></td>
								<td>&nbsp;&nbsp;<?php echo $title;?></td>
								<td>&nbsp;&nbsp;<?php echo $title;?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_food)){echo "$ ".number_format($total_food,2);}?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_food_in_dolar)){echo "$ ".number_format($total_food_in_dolar,2);}?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_food_in_riel)){echo number_format($total_food_in_riel,2)." ៛";}?></td>
							</tr>
	 					<?php }?>	
	 					
	 		<?php ////////////////////////////////// product //////////////////////////////////////////////////////////////////// ?>			
	 					<?php 	$total_product=0;
	 						if(!empty($this->product)){ foreach($this->product as $product){
		 						$total_product = $total_product + $product['subtotal'];
	 							$account_no = $product['account_no'];
	 							$title = $product['category'];
	 						}} 
	 					?>
	 					
	 					<?php 
		 					$total_product_in_riel=0;
		 					$total_product_in_dolar=0;
		 					if(!empty($this->product_amount_money)){
		 						foreach ($this->product_amount_money as $product_money){
		 							$total_product_in_riel = $total_product_in_riel + $product_money['amount_riel'];
		 							$total_product_in_dolar = $total_product_in_dolar + $product_money['amount_usd'];
		 						}
		 					}
	 					?>
	 					
	 					<?php 
	 						if($total_product>0){?>
		 					<tr>
								<td align="center">&nbsp;&nbsp;<?php echo $account_no;?></td>
								<td>&nbsp;&nbsp;<?php echo $title;?></td>
								<td>&nbsp;&nbsp;<?php echo $title;?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_product)){echo "$ ".number_format($total_product,2);}?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_product_in_dolar)){echo "$ ".number_format($total_product_in_dolar,2);}?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_product_in_riel)){echo number_format($total_product_in_riel,2)." ៛";}?></td>
							</tr>
	 					<?php }?>						
	 		
	 		<?php ////////////////////////////////// rental //////////////////////////////////////////////////////////////////// ?>	
	 					
	 					<?php 
	 						$total_rent_payment = 0;$i=0;
	 					?>
	 					<?php if(!empty($this->rent_payment)){foreach ($this->rent_payment as $rent){
	 								$total_rent_payment = $total_rent_payment + $rent['all_total_amount'];
	 						  }}
	 					?>
	 					
	 					<?php 
		 					$total_rent_in_riel=0;
		 					$total_rent_in_dolar=0;
		 					if(!empty($this->rent_amount_money)){
		 						foreach ($this->rent_amount_money as $rent_money){
		 							$total_rent_in_riel = $total_rent_in_riel + $rent_money['amount_riel'];
		 							$total_rent_in_dolar = $total_rent_in_dolar + $rent_money['amount_usd'];
		 						}
		 					}
	 					?>
	 					
	 					<?php if($total_rent_payment>0){?>
		 					<tr>
								<td align="center">&nbsp;&nbsp;<?php echo "006";?></td>
								<td>&nbsp;&nbsp;ចំណូលពីការជួលតូប</td>
								<td>&nbsp;&nbsp;Canteen Rental Fee</td>
								<td align="center">&nbsp;&nbsp;<?php echo "$ ".number_format($total_rent_payment,2);?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_rent_in_dolar)){echo "$ ".number_format($total_rent_in_dolar,2);}?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_rent_in_riel)){echo number_format($total_rent_in_riel,2)." ៛";}?></td>
							</tr>
						<?php }?>
			<?php ////////////////////////////////// parking //////////////////////////////////////////////////////////////////// ?>	
	 					
	 					<?php 
	 						$total_parking_payment = 0;$i=0;
	 					?>
	 					<?php if(!empty($this->parking_payment)){foreach ($this->parking_payment as $parking){
	 								$total_parking_payment = $total_parking_payment + $parking['total_fee'];
	 						  }}
	 					?>
	 					
	 					<?php 
		 					$total_parking_in_riel=0;
		 					$total_parking_in_dolar=0;
		 					if(!empty($this->parking_amount_money)){
		 						foreach ($this->parking_amount_money as $parking_money){
		 							$total_parking_in_riel = $total_parking_in_riel + $parking_money['amount_riel'];
		 							$total_parking_in_dolar = $total_parking_in_dolar + $parking_money['amount_usd'];
		 						}
		 					}
	 					?>
	 					
	 					<?php if($total_parking_payment>0){?>
		 					<tr>
								<td align="center">&nbsp;&nbsp;<?php echo "007";?></td>
								<td>&nbsp;&nbsp;ចំណូលពីផ្ញើរកង់ ម៉ូតូ និង លក់អេតចាយ</td>
								<td>&nbsp;&nbsp;Parking and Sell broken thing Fee</td>
								<td align="center">&nbsp;&nbsp;<?php echo "$ ".number_format($total_parking_payment,2);?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_parking_in_dolar)){echo "$ ".number_format($total_parking_in_dolar,2);}?></td>
								<td align="center">&nbsp;&nbsp;<?php if(!empty($total_parking_in_riel)){echo number_format($total_parking_in_riel,2)." ៛";}?></td>
							</tr>
						<?php }?>
			<?php ////////////////////////////////// other income //////////////////////////////////////////////////////////////////// ?>	
						
						<?php 
	 						$total_other_income_dollar = 0;
	 						$total_other_income_riel = 0;
	 						$other_income_riel = 0;
	 						$i=0;
	 					?>
	 					<?php if(!empty($this->other_income)){foreach ($this->other_income as $income){
	 								if($income['curr_type']==1){
	 									$total_other_income_dollar = $total_other_income_dollar + $income['total_amount'];
	 								}else{
	 									$total_other_income_riel = $total_other_income_riel + $income['total_amount'];
	 								}
	 						  }}
	 						  
	 						  if($total_other_income_riel>0){
	 						  	$other_income_riel = $total_other_income_riel;
	 						  	$total_other_income_riel = " + ".number_format($total_other_income_riel)." ៛ ";
	 						  }else{
	 						  	$total_other_income_riel = "";
	 						  }
	 					?>
	 					<?php if($total_other_income_riel>0 || $total_other_income_dollar>0){?>
		 					<tr>
								<td align="center">&nbsp;&nbsp;<?php echo "008";?></td>
								<td>&nbsp;&nbsp;ចំណូលផ្សេងៗ</td>
								<td>&nbsp;&nbsp;Other Income</td>
								<td align="center">&nbsp;&nbsp;<?php echo " $ ".number_format($total_other_income_dollar,2).$total_other_income_riel;?></td>
								<td align="center">&nbsp;&nbsp;<?php echo " $ ".number_format($total_other_income_dollar,2).$total_other_income_riel;?></td>
								<td align="center">&nbsp;&nbsp;<?php echo "0 ៛";?></td>
							</tr>
						<?php }?>
						
						<?php 
							$grand_total = $total_kft + $total_eft + $total_ept + $total_car + $total_food + $total_product + $total_rent_payment + $total_parking_payment + $total_other_income_dollar;
							$grand_total_in_dollar = $total_khmerft_in_dolar + $total_englishft_in_dolar + $total_englishpt_in_dolar + $total_car_in_dolar + $total_food_in_dolar + $total_product_in_dolar + $total_rent_in_dolar + $total_parking_in_dolar + $total_other_income_dollar;
							$grand_total_in_riel = $total_khmerft_in_riel + $total_englishft_in_riel + $total_englishpt_in_riel + $total_car_in_riel + $total_food_in_riel + $total_product_in_riel + $total_rent_in_riel + $total_parking_in_riel ;
						?>
						
						<tr style="font-size: 20px;font-weight: bold;background: #dadada;">
	 						<td align="center" colspan="3">Grand Total</td>
	 						<td>&nbsp;&nbsp;<?php echo "$ ".number_format($grand_total,2);?></td>
	 						<td>&nbsp;&nbsp;<?php echo "$ ".number_format($grand_total_in_dollar,2);?></td>
	 						<td>&nbsp;&nbsp;<?php echo "$ ".number_format($grand_total_in_riel,2);?></td>
	 						<td></td>
	 					</tr>
					</table>	
					
					
					<table width="100%">
						<tr><td colspan="3">&nbsp;</td></tr>
						<tr >
							<td align="center" width="25%">
								<span style="font-size: 14px;"><?php echo $tr->translate("បានឃើញនិង ឯកភាព"); ?></span><br/>
								<span style="font-weight:bold;color:#000; font-size: 14px;font-family:'Khmer OS Muol';​">លោកអគ្គនាយក</span>
							</td>
							<td  width="20%">
								&nbsp;
							</td>
							<td align="center"  width="30%">
								<span style="font-size: 14px;text-align: right;"><?php echo $tr->translate("VERIFIED_BY"); ?></span><br/>
								<span style="font-size: 14px;text-align: right;"><?php echo $tr->translate("ប្រធានគណនេយ្យ"); ?></span>
							</td>
							<td align="center"  width="25%">
								<span style="font-size: 14px;text-align: right;">ភ្នំពេញ, ថ្ងៃទី…..ខែ…..ឆ្នាំ……..</span><br/>
								<span style="font-size: 14px;text-align: right;"><?php echo $tr->translate("គណនេយ្យករ"); ?></span>
							</td>
						</tr>
					</table>
					</td>
				</tr>
			</table>
		</div>		
	</div>
		
<script type="text/javascript">
	dojo.ready(function(){
		document.getElementById('hide_amount_usd').style.display="none";
	});
	
	function calculateRemainReil(){
		total_amount = '<?php echo number_format($grand_total,2);?>';
		other_income_riel = '<?php echo $other_income_riel;?>';
		amount_usd = dijit.byId("amount_usd").get('value');
		exchange_rate = '<?php echo $this->rate?>';
		total_reil = (total_amount - amount_usd)*exchange_rate;
		//alert(total_amount - amount_usd).toFixed(2);
		
		var total_reil = total_reil.toFixed(2).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
		
		dojo.byId("lb_amount_usd").innerHTML = "&nbsp;&nbsp;$ " + amount_usd;
		dojo.byId("lb_amount_reil").innerHTML = "&nbsp;&nbsp;៛ " + total_reil;
	}
	 					
	function doPrint() {
		document.getElementById('hide_amount_usd').style.display="block";
		document.getElementById('amount_usd').style.display="none";
		
		window.frames["print_frame"].document.body.innerHTML=dojo.byId('divPrint').innerHTML;
	    window.frames["print_frame"].window.focus();
	    window.frames["print_frame"].window.print();
	    //hideDialog();
	    //alert(1);
	    document.getElementById('amount_usd').style.display="block";
	    document.getElementById('hide_amount_usd').style.display="none";
	}
	function preview()
	{ 
	  var disp_setting="toolbar=no,status=no,resizable=no,location=no,directories=yes,menubar=no,"; 
	      disp_setting+="scrollbars=no,width=1200, height=700, left=100, top=25"; 
	  var content_vlue = document.getElementById("divPrint").innerHTML; 
	  
	  var docprint=window.open("","",disp_setting); 
	   docprint.document.open(); 
	   docprint.document.write('<html><head>'); 
	   docprint.document.write('</head><div style=" font-size:16px !important; margin:0px; font-family:Verdana;"><style>table th {font-size:14px !important;} table td{font-size:12px !important;}</style><center>');          
	   docprint.document.write(content_vlue);          
	   docprint.document.write('</center></div></html>'); 
	   docprint.document.close(); 
	   docprint.focus(); 
	}
	function exportExcel(){
		$('#exportExcel').tableExport({type:'excel',escape:'false'});
	}
</script>




